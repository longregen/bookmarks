name: Test Browser Extension

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['main']
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-dist
          path: dist/
          retention-days: 1

  test-chrome:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-dist
          path: dist/

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
        id: setup-chrome

      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run Chrome extension tests
        env:
          BROWSER_TYPE: chrome
          BROWSER_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: xvfb-run --auto-servernum npx tsx tests/extension.test.ts

  test-firefox:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-dist
          path: dist/

      - name: Install Firefox
        uses: browser-actions/setup-firefox@v1
        with:
          firefox-version: latest
        id: setup-firefox

      - name: Install xvfb and web-ext
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          npm install -g web-ext

      - name: Lint extension for Firefox
        run: web-ext lint -s dist --ignore-files "*.map"
        continue-on-error: true

      - name: Run Firefox extension tests
        env:
          BROWSER_TYPE: firefox
          BROWSER_PATH: ${{ steps.setup-firefox.outputs.firefox-path }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: xvfb-run --auto-servernum npx tsx tests/extension.test.ts

      - name: Build Firefox extension package
        run: |
          cd dist
          web-ext build --overwrite-dest
          ls -la web-ext-artifacts/ || echo "No artifacts created"

  test-e2e-chrome:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-dist
          path: dist/

      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: stable
        id: setup-chrome

      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run E2E tests with API
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        env:
          BROWSER_TYPE: chrome
          BROWSER_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: xvfb-run --auto-servernum npx tsx tests/e2e.test.ts

      - name: Skip E2E tests (no API key)
        if: ${{ secrets.OPENAI_API_KEY == '' }}
        run: echo "Skipping E2E tests - OPENAI_API_KEY secret not configured"
