name: Test Browser Extension
permissions:
  contents: read

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['main']
  workflow_dispatch:

env:
  FIREFOX_VERSION: '145.0'
  GECKODRIVER_VERSION: '0.36.0'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome, firefox, web]
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build ${{ matrix.browser }} extension
        run: npm run build:${{ matrix.browser }}

      - name: Upload ${{ matrix.browser }} build artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: ${{ matrix.browser == 'web' && 'webapp' || format('extension-{0}', matrix.browser) }}
          path: dist-${{ matrix.browser }}/
          retention-days: 1

  test-unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:unit:coverage

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript type check
        run: npm run typecheck

  lint-firefox:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Firefox build artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: extension-firefox
          path: dist-firefox/

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Lint extension for Firefox
        run: web-ext lint -s dist-firefox --ignore-files "*.map"

      - name: Build Firefox extension package
        run: |
          cd dist-firefox
          web-ext build --overwrite-dest
          ls -la web-ext-artifacts/ || echo "No artifacts created"

      - name: Upload Firefox package
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: firefox-extension-xpi
          path: dist-firefox/web-ext-artifacts/
          retention-days: 7
          if-no-files-found: ignore

  test-e2e-chrome:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Chrome build artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: extension-chrome
          path: dist-chrome/

      - name: Cache Chromium
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/puppeteer
          key: chromium-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install Chromium via Puppeteer
        run: npx @puppeteer/browsers install chromium@latest

      - name: Install xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb

      - name: Run E2E tests
        env:
          BROWSER_TYPE: chrome
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EXTENSION_PATH: dist-chrome
        run: |
          CHROME_PATH=$(find chromium -name 'chrome' -type f | head -1)
          BROWSER_PATH="$CHROME_PATH" xvfb-run --auto-servernum npm run test:e2e:chrome

  test-e2e-firefox:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Firefox build artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: extension-firefox
          path: dist-firefox/

      - name: Cache Firefox
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        id: cache-firefox
        with:
          path: ${{ runner.tool_cache }}/firefox
          key: firefox-${{ runner.os }}-${{ env.FIREFOX_VERSION }}

      - name: Install Firefox
        uses: browser-actions/setup-firefox@157fcc923ae034d53d4d5b9c7584005fd97e7275 # v1.7.0
        with:
          firefox-version: ${{ env.FIREFOX_VERSION }}
        id: setup-firefox

      - name: Install GeckoDriver
        run: |
          GECKODRIVER_URL="https://github.com/mozilla/geckodriver/releases/download/v${{ env.GECKODRIVER_VERSION }}/geckodriver-v${{ env.GECKODRIVER_VERSION }}-linux64.tar.gz"
          curl -sL "$GECKODRIVER_URL" | sudo tar xz -C /usr/local/bin
          geckodriver --version

      - name: Install xvfb and zip
        run: sudo apt-get update && sudo apt-get install -y xvfb zip

      - name: Run Firefox E2E tests with Selenium
        env:
          BROWSER_PATH: ${{ steps.setup-firefox.outputs.firefox-path }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EXTENSION_PATH: dist-firefox
        run: |
          echo "Running Firefox E2E tests with Selenium/GeckoDriver..."
          xvfb-run --auto-servernum npx tsx tests/e2e-firefox.test.ts

  test-e2e-web:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Web build artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: webapp
          path: dist-web/

      - name: Cache Chromium
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.cache/puppeteer
          key: chromium-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install Chromium via Puppeteer
        run: npx @puppeteer/browsers install chromium@latest

      - name: Run Web E2E tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          CHROME_PATH=$(find chromium -name 'chrome' -type f | head -1)
          BROWSER_PATH="$CHROME_PATH" npx tsx tests/e2e-web.test.ts
