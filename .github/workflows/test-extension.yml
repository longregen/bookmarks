name: Test Browser Extension
permissions:
  contents: read

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['main']
  workflow_dispatch:

# Pin browser versions for consistent caching
env:
  FIREFOX_VERSION: '145.0'
  GECKODRIVER_VERSION: '0.36.0'

jobs:
  # Build Chrome and Firefox in parallel using matrix strategy
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chrome, firefox]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build ${{ matrix.browser }} extension
        run: npm run build:${{ matrix.browser }}

      - name: Upload ${{ matrix.browser }} build artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: extension-${{ matrix.browser }}
          path: dist-${{ matrix.browser }}/
          retention-days: 1

  # Chrome tests use ubuntu-20.04 which has apt-installable Chromium
  # (ubuntu-22.04+ uses snap which doesn't work in CI)
  test-chrome:
    needs: build
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Chrome build artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: extension-chrome
          path: dist-chrome/

      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser xvfb

      - name: Run Chrome extension tests
        env:
          BROWSER_TYPE: chrome
          BROWSER_PATH: /usr/bin/chromium-browser
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EXTENSION_PATH: dist-chrome
        run: xvfb-run --auto-servernum npx tsx tests/extension.test.ts

  # Lint and package Firefox extension
  lint-firefox:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Firefox build artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: extension-firefox
          path: dist-firefox/

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Lint extension for Firefox
        run: web-ext lint -s dist-firefox --ignore-files "*.map"

      - name: Build Firefox extension package
        run: |
          cd dist-firefox
          web-ext build --overwrite-dest
          ls -la web-ext-artifacts/ || echo "No artifacts created"

      - name: Upload Firefox package
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: firefox-extension-xpi
          path: dist-firefox/web-ext-artifacts/
          retention-days: 7
          if-no-files-found: ignore

  test-e2e-chrome:
    needs: build
    runs-on: ubuntu-20.04
    env:
      HAS_API_KEY: ${{ secrets.OPENAI_API_KEY != '' }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Chrome build artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: extension-chrome
          path: dist-chrome/

      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser xvfb

      - name: Run E2E tests with API
        if: env.HAS_API_KEY == 'true'
        env:
          BROWSER_TYPE: chrome
          BROWSER_PATH: /usr/bin/chromium-browser
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EXTENSION_PATH: dist-chrome
        run: xvfb-run --auto-servernum npx tsx tests/e2e.test.ts

      - name: Skip E2E tests (no API key)
        if: env.HAS_API_KEY != 'true'
        run: echo "Skipping E2E tests - OPENAI_API_KEY secret not configured"

  test-e2e-firefox:
    needs: build
    runs-on: ubuntu-latest
    env:
      HAS_API_KEY: ${{ secrets.OPENAI_API_KEY != '' }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Firefox build artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: extension-firefox
          path: dist-firefox/

      - name: Cache Firefox
        uses: actions/cache@6849a6489940f00c2f30c0fb92c6274307ccb58a # v4.1.2
        id: cache-firefox
        with:
          path: ${{ runner.tool_cache }}/firefox
          key: firefox-${{ runner.os }}-${{ env.FIREFOX_VERSION }}

      - name: Install Firefox
        uses: browser-actions/setup-firefox@eb4d4fb885d9ce2a5b629588b498bda3e8a7a78c # v1.5.2
        with:
          firefox-version: ${{ env.FIREFOX_VERSION }}
        id: setup-firefox

      # Install GeckoDriver directly from Mozilla releases (action is broken)
      - name: Install GeckoDriver
        run: |
          GECKODRIVER_URL="https://github.com/mozilla/geckodriver/releases/download/v${{ env.GECKODRIVER_VERSION }}/geckodriver-v${{ env.GECKODRIVER_VERSION }}-linux64.tar.gz"
          curl -sL "$GECKODRIVER_URL" | sudo tar xz -C /usr/local/bin
          geckodriver --version

      - name: Install xvfb and zip
        run: sudo apt-get update && sudo apt-get install -y xvfb zip

      - name: Run Firefox E2E tests with Selenium
        if: env.HAS_API_KEY == 'true'
        env:
          BROWSER_PATH: ${{ steps.setup-firefox.outputs.firefox-path }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EXTENSION_PATH: dist-firefox
        run: |
          echo "Running Firefox E2E tests with Selenium/GeckoDriver..."
          xvfb-run --auto-servernum npx tsx tests/e2e-firefox.test.ts

      - name: Skip Firefox E2E tests (no API key)
        if: env.HAS_API_KEY != 'true'
        run: echo "Skipping Firefox E2E tests - OPENAI_API_KEY secret not configured"
