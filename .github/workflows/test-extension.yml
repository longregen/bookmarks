name: Test Browser Extension
permissions:
  contents: read

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['main']
  workflow_dispatch:

# Pin browser versions for consistent caching
env:
  FIREFOX_VERSION: '145.0'
  GECKODRIVER_VERSION: '0.36.0'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Chrome extension
        run: npm run build:chrome

      - name: Build Firefox extension
        run: npm run build:firefox

      - name: Upload Chrome build artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-chrome
          path: dist-chrome/
          retention-days: 1

      - name: Upload Firefox build artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-firefox
          path: dist-firefox/
          retention-days: 1

  test-chrome:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Chrome build artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-chrome
          path: dist-chrome/

      # Use Chromium instead of Google Chrome because Google Chrome blocks
      # the --load-extension and --disable-extensions-except flags for security.
      # Chromium (the open-source base) allows these flags for testing.
      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser xvfb
          chromium-browser --version

      - name: Run Chrome extension tests
        env:
          BROWSER_TYPE: chrome
          BROWSER_PATH: /usr/bin/chromium-browser
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EXTENSION_PATH: dist-chrome
        run: xvfb-run --auto-servernum npx tsx tests/extension.test.ts

  # Lint and package Firefox extension
  # Note: Real Firefox E2E testing is done in the test-e2e-firefox job using Selenium
  lint-firefox:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Firefox build artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-firefox
          path: dist-firefox/

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Lint extension for Firefox
        # web-ext lint exits with non-zero on errors (fails the build)
        # Warnings are displayed but don't fail the build - this is expected behavior
        # The UNSAFE_VAR_ASSIGNMENT warnings for innerHTML come from @mozilla/readability,
        # Mozilla's own library for extracting article content. These are false positives
        # as the library uses innerHTML on controlled content, not user input.
        run: web-ext lint -s dist-firefox --ignore-files "*.map"

      - name: Build Firefox extension package
        run: |
          cd dist-firefox
          web-ext build --overwrite-dest
          ls -la web-ext-artifacts/ || echo "No artifacts created"

      - name: Upload Firefox package
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension-xpi
          path: dist-firefox/web-ext-artifacts/
          retention-days: 7
          if-no-files-found: ignore

  test-e2e-chrome:
    needs: build
    runs-on: ubuntu-latest
    env:
      HAS_API_KEY: ${{ secrets.OPENAI_API_KEY != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Chrome build artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-chrome
          path: dist-chrome/

      # Use Chromium instead of Google Chrome because Google Chrome blocks
      # the --load-extension and --disable-extensions-except flags for security.
      - name: Install Chromium
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser xvfb

      - name: Run E2E tests with API
        if: env.HAS_API_KEY == 'true'
        env:
          BROWSER_TYPE: chrome
          BROWSER_PATH: /usr/bin/chromium-browser
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EXTENSION_PATH: dist-chrome
        run: xvfb-run --auto-servernum npx tsx tests/e2e.test.ts

      - name: Skip E2E tests (no API key)
        if: env.HAS_API_KEY != 'true'
        run: echo "Skipping E2E tests - OPENAI_API_KEY secret not configured"

  test-e2e-firefox:
    needs: build
    runs-on: ubuntu-latest
    env:
      HAS_API_KEY: ${{ secrets.OPENAI_API_KEY != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Download Firefox build artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-firefox
          path: dist-firefox/

      # Cache Firefox browser download
      - name: Cache Firefox
        uses: actions/cache@v4
        id: cache-firefox
        with:
          path: ${{ runner.tool_cache }}/firefox
          key: firefox-${{ runner.os }}-${{ env.FIREFOX_VERSION }}

      - name: Install Firefox
        uses: browser-actions/setup-firefox@v1
        with:
          firefox-version: ${{ env.FIREFOX_VERSION }}
        id: setup-firefox

      # Cache GeckoDriver download
      - name: Cache GeckoDriver
        uses: actions/cache@v4
        id: cache-geckodriver
        with:
          path: ${{ runner.tool_cache }}/geckodriver
          key: geckodriver-${{ runner.os }}-${{ env.GECKODRIVER_VERSION }}

      - name: Install GeckoDriver
        uses: browser-actions/setup-geckodriver@latest
        with:
          geckodriver-version: ${{ env.GECKODRIVER_VERSION }}

      - name: Install xvfb and zip
        run: sudo apt-get update && sudo apt-get install -y xvfb zip

      - name: Run Firefox E2E tests with Selenium
        if: env.HAS_API_KEY == 'true'
        env:
          BROWSER_PATH: ${{ steps.setup-firefox.outputs.firefox-path }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          EXTENSION_PATH: dist-firefox
        run: |
          echo "Running Firefox E2E tests with Selenium/GeckoDriver..."
          xvfb-run --auto-servernum npx tsx tests/e2e-firefox.test.ts

      - name: Skip Firefox E2E tests (no API key)
        if: env.HAS_API_KEY != 'true'
        run: echo "Skipping Firefox E2E tests - OPENAI_API_KEY secret not configured"
