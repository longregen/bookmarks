name: Publish to Browser Stores
permissions:
  contents: read

on:
  release:
    types: [published]

jobs:
  publish-chrome:
    name: Publish to Chrome Web Store
    runs-on: ubuntu-latest
    steps:
      - name: Download Chrome extension from release
        uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05
        with:
          repository: ${{ github.repository }}
          tag: ${{ github.event.release.tag_name }}
          fileName: bookmark-rag-chrome.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Chrome Web Store
        uses: mnao305/chrome-extension-upload@4008e29e13c144d0f6725462cbd49b7c291b4928
        with:
          file-path: bookmark-rag-chrome.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}
          publish: true

  publish-firefox:
    name: Publish to Firefox Add-ons
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code (for source submission)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Download Firefox extension from release
        uses: robinraju/release-downloader@daf26c55d821e836577a15f77d86ddc078948b05
        with:
          repository: ${{ github.repository }}
          tag: ${{ github.event.release.tag_name }}
          fileName: bookmark-rag-firefox.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare source code archive
        run: |
          zip -r source-code.zip . \
            -x "node_modules/*" \
            -x "dist-*/*" \
            -x ".git/*" \
            -x "*.zip" \
            -x ".github/*"

      - name: Upload to Firefox Add-ons
        uses: kewisch/action-web-ext@fe10addf5d5e5ba6b78ffde720dd488a27d10e8c
        with:
          cmd: sign
          source: bookmark-rag-firefox.zip
          channel: listed
          apiKey: ${{ secrets.FIREFOX_API_KEY }}
          apiSecret: ${{ secrets.FIREFOX_API_SECRET }}
          sourceCode: source-code.zip
          license: MIT
          metaDataFile: amo-metadata.json
